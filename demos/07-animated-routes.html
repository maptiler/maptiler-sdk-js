<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animations and Animated Routes</title>
  <style>
    html {
      height: 100%;
      font-family: sans-serif;
      font-size: 13px;
    }

    body {
      height: 100%;
      margin: 0;
      display: grid;
      /* grid-template: 1fr 1fr / 1fr 1fr; */
      /* gap: 16px; */
      box-sizing: border-box;
    }

    .map {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .controls-container {
      position: absolute;
      top: 16px;
      left: 16px;
      gap: 8px;
      z-index: 1;
    }

    .controls {
      display: flex;
    }

    .padded, button {
      display: inline-flex;
      align-items: center;
      border-radius: 8px;
      background-color: white;
      padding: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      margin-right: 4px;
    }

    button {
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="../build/maptiler-sdk.css">
</head>
<body>
  <div class="controls-container">
    <div class="controls">
      <button id="play">
        Play
      </button>
      <button id="pause">
        Pause
      </button>
      <button id="faster">
        Faster
      </button>
      <button id="slower">
        Slower
      </button>
      <div id="playbackRate" class="padded">1.0x</div>
    </div>
    <div id="keyframeName" class="padded" style="display: none">
    </div>
  </div>
  <script src="../build/maptiler-sdk.umd.min.js"></script>
  <script src="//cdn.maptiler.com/maptiler-3d/v2.0.2/maptiler-3d.umd.min.js"></script>
  <script src="assets/demo-utils.js"></script>
  <script>

    addPerformanceStats();
    setupMapTilerApiKey();

    function getRandomMapStyle() {
      const styles = Object.keys(maptilersdk.MapStyle);
      const style = maptilersdk.MapStyle[styles[Math.floor(Math.random() * styles.length)]];
      const variants = Object.keys(style.variants);
      const variant = style[variants[Math.floor(Math.random() * variants.length)]];
      return variant;
    }

    function getElementsByIds(ids) {
      return ids.map(id => document.getElementById(id));
    }

    async function createMap(id, nextMapId) {
      const element = document.createElement("div");
      element.className = "map";
      document.body.appendChild(element);

      const map = new maptilersdk.Map({
        container: element,
        style: maptilersdk.MapStyle.OUTDOOR.VIVID,
        hash: false,
        geolocateControl: false,
        navigationControl: false,
        terrain: true,
        bearing: -30,
        maxPitch: 65,
        pitch: 60,
        zoom: 17,
        center: [
          -7.453472539769251,
          39.415519175998355
        ]
      });
      window.map = map

      return map;
    }

    async function loadGeoJSON() {
      try {
        const response = await fetch('/demos/assets/routes/run.geojson');
        const data = await response.json();
        return data;
      } catch(e) {
        console.error('Error loading GeoJSON:', e);
      }
    }

    async function main() {
      const geojson = await loadGeoJSON();
      
      const map = await createMap('map-map');

      await map.onReadyAsync()

      const ROUTE_SOURCE_ID = 'routes';

      map.addSource(ROUTE_SOURCE_ID, {
        type: 'geojson',
        data: geojson,
        lineMetrics: true, // this is needed for the animated route
      });

      map.addLayer({
        id: ROUTE_SOURCE_ID,
        type: 'line',
        source: ROUTE_SOURCE_ID,
        layout: {
          'line-join': 'round',
          'line-cap': 'round',
          'visibility': 'visible'
        },
        paint: {
          'line-color': `rgba(0, 255, 0, 0.75)`,
          'line-width': 8,
          'line-opacity': 0.75
        }
      });


      const img = await map.loadImage('/demos/assets/routes/mt.png');

      map.addImage('maptiler', img.data);

      map.addLayer({
        id: ROUTE_SOURCE_ID + '-points',
        type: 'symbol',
        source: ROUTE_SOURCE_ID,
        layout: {
          'icon-image': 'maptiler',
          'icon-size': 0.2,
        },
        paint: {}
      });

      const animatedRouteLayer = new maptilersdk.AnimatedRouteLayer({
        source: {
          id: ROUTE_SOURCE_ID,
          featureSetIndex: 0,
          layerID: ROUTE_SOURCE_ID,
        },
        duration: 25000,
        iterations: 3,
        pathStrokeAnimation: {
          activeColor: [255, 123, 0, 0.75],
          inactiveColor: [0, 255, 0, 0.75],
        },
        cameraAnimation: {
          follow: true,
          pathSmoothing: {
            resolution: 20,
            epsilon: 10,
          },
        },
      });

      map.addLayer(animatedRouteLayer);

      const animatedMarkersLayer = new maptilersdk.AnimatedRouteLayer({
        keyframes: getKeyframes(),
        duration: 15000,
        delay: 1000,
        iterations: 5,
        cameraAnimation: {
          follow: true,
          pathSmoothing: false,
        },
      });

      const keyframeNameElement = document.getElementById('keyframeName');

      animatedRouteLayer.addEventListener('animationend', async () => {
        map
          .removeLayer(animatedRouteLayer.id)
          .addLayer(animatedMarkersLayer)

        keyframeNameElement.style.display = 'block';

        animatedMarkersLayer.play();
      });

      animatedMarkersLayer.addEventListener('animationend', async () => {
        map
          .removeLayer(animatedMarkersLayer.id)
          .addLayer(animatedRouteLayer)

        keyframeNameElement.style.display = 'none';

        animatedRouteLayer.play();
      });

      animatedMarkersLayer.addEventListener('keyframe', (e) => {
        const keyframeName = e.keyframe.userData?.name;
        if (keyframeNameElement) keyframeNameElement.innerText = keyframeName;
      });

      animatedRouteLayer.addEventListener('playbackratechange', (e) => {
        const playbackRateElement = document.getElementById('playbackRate');
         playbackRateElement.innerText = e.playbackRate.toFixed(1) + 'x';
      });

      const [
        playButton,
        pauseButton,
        fasterButton,
        slowerButton
      ] = getElementsByIds([
        'play',
        'pause',
        'faster',
        'slower'
      ]);
      
      playButton.addEventListener('click', () => {
        animatedRouteLayer.play();
      });

      pauseButton.addEventListener('click', () => {
        animatedRouteLayer.pause();
      });

      fasterButton.addEventListener('click', () => {
        const currentSpeed = animatedRouteLayer.animationInstance.getPlaybackRate();
        animatedRouteLayer.animationInstance.setPlaybackRate(currentSpeed + 0.2);
      });

      slowerButton.addEventListener('click', () => {
        const currentSpeed = animatedRouteLayer.animationInstance.getPlaybackRate();
        animatedRouteLayer.animationInstance.setPlaybackRate(currentSpeed - 0.2);
      });
    }

    main()

    function getKeyframes() {
      return [
        {
          delta: 0,
          easing: 'Elastic.Out',
          userData: {
            name: 'Start',
          },
          props: {
            lng: -7.453472539769251,
            lat: 39.415519175998355,
            zoom: 16,
            pitch: 40,
            bearing: -30,
          }
        },
        {
          delta: 0.1,
          easing: 'Elastic.Out',
          userData: {
            name: 'Nossa Senhora da Penha 1',
          },
          props: {
            lng: -7.464899329058538,
            lat: 39.41042140236023,
            zoom: 16,
            pitch: 60,
            bearing: -70,
          }
        },
        {
          delta: 0.3,
          easing: 'Elastic.Out',
          userData: {
            name: 'Nossa Senhora da Penha 2',
          },
          props: {
            lng: -7.464899329058538,
            lat: 39.41042140236023,
            zoom: 16,
            pitch: 60,
            bearing: -70,
          }
        },
        {
          delta: 0.5,
          easing: 'Elastic.Out',
          userData: {
            name: 'Farmland 1',
          },
          props: {
            lng: -7.445160082758153,
            lat: 39.41918918515162, 
            zoom: 15,
            pitch: 90,
            bearing: -150,
          }
        },
        {
          delta: 0.7,
          easing: 'Bounce.In',
          userData: {
            name: 'Farmland 2',
          },
          props: {
            lng: -7.445160082758153,
            lat: 39.41918918515162, 
            zoom: 15,
          }
        },
        {
          delta: 0.8,
          easing: 'Bounce.Out',
          userData: {
            name: 'Castelo de Vide: Castelo 1',
          },
          props: {
            lng: -7.457803520606888,
            lat: 39.41755616216083,
            zoom: 16,
          }
        },
        {
          delta: 0.9,
          easing: 'Elastic.Out',
          userData: {
            name: 'Castelo de Vide: Castelo 1',
          },
          props: {
            lng: -7.457803520606888,
            lat: 39.41755616216083,
            zoom: 16,
          }
        },
        {
          delta: 1,
          easing: 'Elastic.Out',
          userData: {
            name: 'Finish',
          },
          props: {
            lng: -7.453472539769251,
            lat: 39.415519175998355,
            zoom: 17,
            pitch: 60,
            bearing: -330,
          }
        },
      ]
    }
  </script>
</body>
</html>